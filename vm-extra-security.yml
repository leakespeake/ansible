---
- name: Additional Ubuntu 20.04 security
  hosts: all  # amend ansible groups via inventory.ini for centralized node targeting (across playbooks)
  become: yes
  vars:
    ubuntu_username: ubuntu 
    ufw_ssh_port: 22
    ufw_docker_port: 2376
    ufw_node_exporter_port: 9100

  tasks:
    # CRON JOB TO UPDATE SYSTEM - crontab -l / crontab -e  
    - name: Cron jobs
      cron:
        name: Update packages
        user: "{{ ubuntu_username }}"
        special_time: monthly
        job: "sudo apt update && sudo apt -y upgrade"

    # UFW (uncomplicated firewall) - INSTALL, CONFIGURE & ENABLE
    - name: Install ufw
      apt:
        name: ufw
        state: present

    - name: Configure ufw defaults
      ufw: direction={{ item.direction }} policy={{ item.policy }}
      with_items:
        - { direction: 'incoming', policy: 'deny' }
        - { direction: 'outgoing', policy: 'allow' }
      notify:
        - restart ufw

    - name: Configure ufw rules
      ufw: rule={{ item.rule }} port={{ item.port }} proto={{ item.proto }}
      with_items:
        - { rule: 'allow', port: '{{ ufw_ssh_port }}', proto: 'tcp' }
        - { rule: 'allow', port: '{{ ufw_docker_port }}', proto: 'tcp' }
        - { rule: 'allow', port: '{{ ufw_node_exporter_port }}', proto: 'tcp' }
      notify:
        - restart ufw

    - name: Enable ufw logging
      ufw: logging=on
      notify:
        - restart ufw

    - name: Enable ufw
      ufw: 
        state: enabled

    # OPENSSH - HARDEN CONFIGURATION
    - name: Harden sshd configuration
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
        state: present
        validate: 'sshd -t -f %s'
      with_items:
        - regexp: "^PasswordAuthentication\ "
          line: "PasswordAuthentication no"
        - regexp: "^PermitRootLogin\ "
          line: "PermitRootLogin no"
        - regexp: "^#PermitEmptyPasswords\ "
          line: "PermitEmptyPasswords no"
      notify:
        - restart sshd

    # FAIL2BAN - INSTALL & CONFIGURE - (defaults to 5 ssh logon attempts prior to 10 minute ban)
    - name: Install fail2ban
      apt: 
        name: fail2ban
        state: latest
        update_cache: yes

    - name: Copy default config to .local file for fail2ban to read as master
      copy:
        src: /etc/fail2ban/jail.conf
        dest: /etc/fail2ban/jail.local
        remote_src: yes
        force: no
        owner: root
        group: root
        mode: 0644

    - name: Configure jail.local
      lineinfile:
        path: /etc/fail2ban/jail.local
        regexp: "^#ignoreip = 127.0.0.1/8 ::1"
        line: "ignoreip = 127.0.0.1/8 ::1 192.168.0.0/24"
      notify:
        - restart fail2ban

  handlers:
  - name: restart ufw
    service:
      name: ufw
      state: restarted

  - name: restart sshd
    service:
      name: sshd
      state: restarted

  - name: restart fail2ban
    service:
      name: fail2ban
      state: restarted